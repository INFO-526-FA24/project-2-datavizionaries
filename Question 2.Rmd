---
title: "Question 2"
author: "Kapil Parab"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(janitor)
library(rnaturalearth)
library(rnaturalearthdata)
library(caret)
library(pROC)
```
# Reading dataset

```{r}
data <- read.csv("data/mental_health.csv", header = TRUE)
```

# Cleaned data
```{r}
data_clean <- data %>% 
  mutate(
    Timestamp = parse_date_time(
      Timestamp, orders = "mdy HM"
    ),
    diagnosed = ifelse(treatment == "Yes", 1, 0),
    Occupation = ifelse(Occupation == "Housewife", "Homemaker", Occupation)
  ) %>% within(., rm(treatment)) %>%
  filter(self_employed != "") %>%
  clean_names()
```

# Distribution of Cases by Country
```{r}
country_distribution <- data_clean %>%
  group_by(country) %>%
  summarise(
    count = n(),
    diagnosed_rate = mean(diagnosed)
  )

# Load a world map
world <- ne_countries(scale = "medium", returnclass = "sf")

# Join the summarized data with the world map
world_data <- world %>%
  left_join(country_distribution, by = c("name_long" = "country")) %>%
  filter(., name_long != "Antarctica")

# Plot the map
ggplot(data = world_data) +
  geom_sf(aes(fill = diagnosed_rate), color = "white", size = 0.1) +
  scale_fill_gradient(
    name = "Diagnosed Rate",
    low = "#D1AE82FF",  # Starting color
    high = "#5D3A9B", # Ending color
    na.value = "gray80"  # Color for missing data
  ) +
  labs(
    title = "Distribution of Diagnosed Cases by Country",
    subtitle = "Proportion of diagnosed individuals across surveyed countries"
  ) +
  theme(
    legend.position = "bottom",
    legend.key.width = unit(3, "cm"),
    legend.key.height = unit(0.5, "cm"),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12, face = "bold"),
    panel.background = element_rect(fill = "lightblue")
  ) +
  guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5))

ggsave("country_diagnosis.png", dpi = 350, path = "plots")
```

# Distribution of Cases by Occupation

```{r}
# Summarize the data
occupation_distribution <- data_clean %>%
  group_by(occupation, diagnosed) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(diagnosed_label = ifelse(diagnosed == 1, "Yes", "No"))

# Plot the multiset bar chart
ggplot(occupation_distribution, aes(x = occupation, y = count, fill = diagnosed_label)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(
    aes(label = round(count, 1)), 
    position = position_dodge(width = 0.9), 
    vjust = -0.5, 
    size = 3
  ) +
  labs(
    title = "Distribution of Diagnosed by Occupation",
    x = "Occupation",
    y = "Count",
    fill = "Diagnosed"
  ) +
  scale_fill_manual(values = c("Yes" = "#D1AE82FF", "No" = "#5D3A9B")) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggsave("occupation.png", dpi = 350, path = "plots")
```

# Distribution of Cases by Days Spent Indoors

```{r}
# Summarize the data
indoors_distribution <- data_clean %>%
  group_by(days_indoors, diagnosed) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(diagnosed_label = ifelse(diagnosed == 1, "Yes", "No"))

# Plot the multiset bar chart
ggplot(indoors_distribution, aes(x = days_indoors, y = count, fill = diagnosed_label)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(
    aes(label = round(count, 1)), 
    position = position_dodge(width = 0.9), 
    vjust = -0.5, 
    size = 3
  ) +
  labs(
    title = "Distribution of Diagnosed by Days Indoor",
    x = "Days Indoor",
    y = "Count",
    fill = "Diagnosed"
  ) +
  scale_fill_manual(values = c("Yes" = "#D1AE82FF", "No" = "#5D3A9B")) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggsave("days_indoor.png", dpi = 350, path = "plots")
```


# Chi - Square test to find associations

```{r}
# Chi-Square Test for `diagnosed` and `country`
country_table <- table(data_clean$diagnosed, data_clean$country) # Create a contingency table
country_chisq <- chisq.test(country_table) # Perform the Chi-Square Test
print("Chi-Square Test for Diagnosed and Country:")
print(country_chisq)
# A large Chi-Square value indicates that the association between diagnosed and country is very strong

# Chi-Square Test for `diagnosed` and `days_indoor`
indoor_table <- table(data_clean$diagnosed, data_clean$days_indoor) # Create a contingency table
indoor_chisq <- chisq.test(indoor_table) # Perform the Chi-Square Test
print("Chi-Square Test for Diagnosed and Days Indoor:")
print(indoor_chisq)

# Chi-Square Test for `diagnosed` and `occupation`
occupation_table <- table(data_clean$diagnosed, data_clean$occupation) # Create a contingency table
occupation_chisq <- chisq.test(occupation_table) # Perform the Chi-Square Test
print("Chi-Square Test for Diagnosed and Occupation:")
print(occupation_chisq)
# Since the p-value (0.00052) is less than 0.05, we reject the null hypothesis. This means there is a statistically significant association between diagnosed (mental health treatment) and occupation
```
# Fitting Linear Regression model to predict diagnosed

```{r}
# Ensure the target variable is binary
lm_data <- data_clean %>%
  mutate(diagnosed = as.factor(diagnosed)) # Convert to factor for logistic regression

# Select relevant predictor variables (e.g., country, occupation, family_history)
logistic_data <- lm_data %>%
  select(diagnosed, country, occupation, self_employed, family_history)

# Convert categorical variables to factors
logistic_data <- logistic_data %>%
  mutate(across(c(country, occupation, self_employed, family_history), as.factor))

# Fit the logistic regression model
logistic_model <- glm(diagnosed ~ country + occupation + self_employed + family_history,
                      data = logistic_data,
                      family = binomial)

# Summarize the model
summary(logistic_model)

# Predict probabilities for the training data
logistic_data$predicted_prob <- predict(logistic_model, type = "response")

# Convert probabilities to class labels (threshold = 0.5)
logistic_data$predicted_class <- ifelse(logistic_data$predicted_prob > 0.5, 1, 0)

# View predictions
head(logistic_data)
```

# LM Confusion Matrix

```{r}
confusionMatrix(as.factor(logistic_data$predicted_class), logistic_data$diagnosed)
```

# LM Evaluation

```{r}
roc_curve <- roc(logistic_data$diagnosed, logistic_data$predicted_prob)
plot(roc_curve)
auc(roc_curve)
```